module Geolocal
  module Provider
    class Base
      def initialize params={}
        @config = params.merge(Geolocal.configuration.to_hash)
      end

      def config
        @config
      end

      def download
        # TODO: skip download if local files are new enough
        # TODO: provide a FORCE argument to force download anyway
        download_files
      end

      def countries
        @countries ||= config[:countries].merge(config[:countries]) { |name, country_codes|
          Array(country_codes).map(&:upcase).to_set
        }
      end

      def update
        results = countries.merge(countries) { "" }

        read_ranges do |name,lo,hi|
          results[name] << "#{IPAddr.new(lo).to_i}..#{IPAddr.new(hi).to_i},\n"
        end

        output results
      end

      def output results
        names = countries.keys

        out = <<-EOL.gsub(/^      /, '')
          # This file is autogenerated

          Defines #{names.map { |n| "#{config.module}::#{n}" }.join(', ')}
              and #{names.map { |n| "#{config.module}.in_#{n}?" }.join(', ')}

          module #{config[:module]}
        EOL

        methods = names.map do |n|
          <<-EOL.gsub(/^      /, '')
            def self.in_#{n}? addr
              num = addr.to_i
              #{n}.bsearch { |range| num > range.max ? 1 : num < range.min ? -1 : 0 }
            end
          EOL
        end

        out << methods.join("\n")
        out << "end\n\n"

        definitions = countries.map do |name, body|
          <<-EOL.gsub(/^      /, '')
          #{config.module}::#{name} = [
            #{body}
          ]

          EOL
        end

        out << definitions.join("\n")
        out
      end
    end
  end
end
